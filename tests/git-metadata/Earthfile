VERSION 0.7

ARG --global DOCKERHUB_USER_SECRET=+secrets/DOCKERHUB_USER
ARG --global DOCKERHUB_TOKEN_SECRET=+secrets/DOCKERHUB_TOKEN
ARG --global DOCKERHUB_MIRROR
ARG --global DOCKERHUB_MIRROR_INSECURE=false
ARG --global DOCKERHUB_AUTH=true

git:
    FROM alpine:3.15

    RUN apk add --update build-base curl-dev expat-dev openssl-dev>3 pcre2-dev perl-dev perl-error xmlto zlib-dev asciidoc python3-dev tcl tk libsecret-dev glib-dev docbook2x

    GIT CLONE git@github.com:git/git.git /git
    WORKDIR /git

    ENV NO_GETTEXT=YesPlease
    ENV NO_SVN_TESTS=YesPlease
    ENV NO_REGEX=YesPlease
    ENV NO_SYS_POLL_H=1
    ENV ICONV_OMITS_BOM=Yes
    ENV INSTALL_SYMLINKS=1
    ENV USE_LIBPCRE2=YesPlease
    ENV PYTHON_PATH=/usr/bin/python3

    RUN mkdir /gitbuild
    RUN make prefix=/gitbuild all doc info
    RUN make prefix=/gitbuild install install-doc install-html install-info
    SAVE ARTIFACT /gitbuild

git-cached:
    FROM alpine:3.15
    ARG USE_CACHED_GIT_BINARIES=true
    IF [ "$USE_CACHED_GIT_BINARIES" = "true" ]
        # make use of a pre-compiled version
        FROM earthly/earthly:git-binary-for-metadata-test
    ELSE
        FROM scratch
        COPY +git/gitbuild /gitbuild
        SAVE IMAGE --push earthly/earthly:git-binary-for-metadata-test
    END
    SAVE ARTIFACT /gitbuild

test:
    FROM ../git-ssh-server/setup+server \
        --DOCKERHUB_AUTH=$DOCKERHUB_AUTH \
        --DOCKERHUB_USER_SECRET=$DOCKERHUB_USER_SECRET \
        --DOCKERHUB_TOKEN_SECRET=$DOCKERHUB_TOKEN_SECRET \
        --DOCKERHUB_MIRROR=$DOCKERHUB_MIRROR \
        --DOCKERHUB_MIRROR_INSECURE=$DOCKERHUB_MIRROR_INSECURE \
        --SSHD_RSA=true \
        --SSHD_ED25519=false \
        --USER_RSA=true \
        --USER_ED25519=false
    COPY test.earth Earthfile

    # git version 2.34.5 (given to us by apk add), will sometimes fail on the git commit
    # when looking up the git author email (fails with "please tell me who you are" errors)
    # this even happens when the GIT_AUTHOR_EMAIL env is set.
    # Instead we use a more recent version of git we have compiled from source
    COPY +git-cached/gitbuild /gitbuild

    RUN git --version
    RUN /gitbuild/bin/git --version
    RUN echo "#!/bin/sh
set -ex

# use the latest version of git
PATH=/gitbuild/bin/:$PATH

git --version

# first ensure these two /etc/hosts entries are working
ping -c 1 git.example.com
ping -c 1 buildkitsandbox

# load in preauthorized key
eval \$(ssh-agent)
ssh-add /root/self-hosted-rsa-key
ssh-add -l

# next validate ssh is working
ssh git@git.example.com | grep \"Hi git! You've successfully authenticated, but you get no shellz\"

# setup git email and user (needed to commit)
git config --global user.email \"onlyspammersemailthis@earthly.dev\"
git config --global user.name \"test name\"

# test this worked (seems to be flaky in some tests)
cat \$HOME/.gitconfig
git config --global user.name
git config --global user.email
test -n \"\$(git config --global user.name)\"
test -n \"\$(git config --global user.email)\"

# clone the repo and add a test Earthfile to it
git clone git@git.example.com:testuser/repo.git
mv Earthfile repo/
git -C repo add Earthfile
git -C repo commit -m \"test

Co-authored-by: Testy McTest <testy@earthly.dev>
Co-authored-by: Coverage McCover <cover@earthly.dev>\"
sleep 1 # force the commit time to change
test -n \"\$(git config --global user.name)\"
test -n \"\$(git config --global user.email)\"
git -C repo commit --amend --no-edit
git -C repo push
export expected_sha=\$(git -C repo rev-parse HEAD)
export expected_committer_timestamp=\$(git -C repo log -1 --format=\"%ct\")
export expected_author_timestamp=\$(git -C repo log -1 --format=\"%at\")
test \"\$expected_committer_timestamp\" -ne \"\$expected_author_timestamp\"

# finally perform earthly tests
earthly --config \$earthly_config --verbose -D --build-arg expected_sha \
--build-arg expected_committer_timestamp --build-arg expected_author_timestamp ./repo+test-git-metadata

rm -rf repo
earthly --config \$earthly_config --verbose -D --build-arg expected_sha \
--build-arg expected_committer_timestamp --build-arg expected_author_timestamp git.example.com/testuser/repo:main+test-git-metadata
" >/tmp/test-earthly-script && chmod +x /tmp/test-earthly-script
    DO +RUN_EARTHLY_ARGS --pre_command=start-sshd --exec_cmd=/tmp/test-earthly-script

RUN_EARTHLY_ARGS:
    COMMAND
    ARG earthfile
    ARG pre_command
    ARG exec_cmd
    DO ..+RUN_EARTHLY \
        --earthfile=$earthfile \
        --pre_command=$pre_command \
        --exec_cmd=$exec_cmd \
        --DOCKERHUB_AUTH=$DOCKERHUB_AUTH \
        --DOCKERHUB_USER_SECRET=$DOCKERHUB_USER_SECRET \
        --DOCKERHUB_TOKEN_SECRET=$DOCKERHUB_TOKEN_SECRET \
        --DOCKERHUB_MIRROR=$DOCKERHUB_MIRROR \
        --DOCKERHUB_MIRROR_INSECURE=$DOCKERHUB_MIRROR_INSECURE
